## httpåè®®

## åŒæºç­–ç•¥

åŒæºç­–ç•¥å¯é˜²æ­¢ JavaScript å‘èµ·è·¨åŸŸè¯·æ±‚ã€‚åŒæºè¢«å®šä¹‰ä¸º URIã€ä¸»æœºåå’Œç«¯å£å·çš„ç»„åˆã€‚æ­¤ç­–ç•¥å¯é˜²æ­¢é¡µé¢ä¸Šçš„æ¶æ„è„šæœ¬é€šè¿‡è¯¥é¡µé¢çš„æ–‡æ¡£å¯¹è±¡æ¨¡å‹ï¼Œè®¿é—®å¦ä¸€ä¸ªç½‘é¡µä¸Šçš„æ•æ„Ÿæ•°æ®ã€‚

## è·¨åŸŸ

* åŸå› 
  æµè§ˆå™¨çš„åŒæºç­–ç•¥å¯¼è‡´äº†è·¨åŸŸ
* ä½œç”¨
  ç”¨äºéš”ç¦»æ½œåœ¨æ¶æ„æ–‡ä»¶çš„é‡è¦å®‰å…¨æœºåˆ¶
* è§£å†³
  jsonp ï¼Œå…è®¸ script åŠ è½½ç¬¬ä¸‰æ–¹èµ„æº
  åå‘ä»£ç†ï¼ˆnginx æœåŠ¡å†…éƒ¨é…ç½® Access-Control-Allow-Origin *ï¼‰
  cors å‰åç«¯åä½œè®¾ç½®è¯·æ±‚å¤´éƒ¨ï¼ŒAccess-Control-Allow-Origin ç­‰å¤´éƒ¨ä¿¡æ¯
  iframe åµŒå¥—é€šè®¯ï¼Œpostmessage
  ä¸‰ä¸ªå…è®¸è·¨åŸŸåŠ è½½èµ„æºçš„æ ‡ç­¾ï¼šimg link script
*
è·¨åŸŸæ˜¯å¯ä»¥å‘é€è¯·æ±‚ï¼Œåç«¯ä¹Ÿä¼šæ­£å¸¸è¿”å›ç»“æœï¼Œåªä¸è¿‡è¿™ä¸ªç»“æœè¢«æµè§ˆå™¨æ‹¦æˆªäº†ï¼
*
JSONP
*
CORS
*
websocket
*

## ä¸€æ¬¡å®Œæ•´çš„HTTPè¯·æ±‚æ‰€ç»å†çš„7ä¸ªæ­¥éª¤

```
HTTPé€šä¿¡æœºåˆ¶æ˜¯åœ¨ä¸€æ¬¡å®Œæ•´çš„HTTPé€šä¿¡è¿‡ç¨‹ä¸­ï¼ŒWebæµè§ˆå™¨ä¸WebæœåŠ¡å™¨ä¹‹é—´å°†å®Œæˆä¸‹åˆ—7ä¸ªæ­¥éª¤ï¼š

å»ºç«‹TCPè¿æ¥
åœ¨HTTPå·¥ä½œå¼€å§‹ä¹‹å‰ï¼ŒWebæµè§ˆå™¨é¦–å…ˆè¦é€šè¿‡ç½‘ç»œä¸WebæœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼Œè¯¥è¿æ¥æ˜¯é€šè¿‡TCPæ¥å®Œæˆçš„ï¼Œè¯¥åè®®ä¸IPåè®®å…±åŒæ„å»º Internetï¼Œå³è‘—åçš„TCP/IPåè®®æ—ï¼Œå› æ­¤Internetåˆè¢«ç§°ä½œæ˜¯TCP/IPç½‘ç»œã€‚HTTPæ˜¯æ¯”TCPæ›´é«˜å±‚æ¬¡çš„åº”ç”¨å±‚åè®®ï¼Œæ ¹æ®è§„åˆ™ï¼Œ åªæœ‰ä½å±‚åè®®å»ºç«‹ä¹‹åæ‰èƒ½ï¼Œæ‰èƒ½è¿›è¡Œæ›´å±‚åè®®çš„è¿æ¥ï¼Œå› æ­¤ï¼Œé¦–å…ˆè¦å»ºç«‹TCPè¿æ¥ï¼Œä¸€èˆ¬TCPè¿æ¥çš„ç«¯å£å·æ˜¯80ã€‚

Webæµè§ˆå™¨å‘WebæœåŠ¡å™¨å‘é€è¯·æ±‚è¡Œ
ä¸€æ—¦å»ºç«‹äº†TCPè¿æ¥ï¼ŒWebæµè§ˆå™¨å°±ä¼šå‘WebæœåŠ¡å™¨å‘é€è¯·æ±‚å‘½ä»¤ã€‚ä¾‹å¦‚ï¼šGET /sample/hello.jsp HTTP/1.1ã€‚

Webæµè§ˆå™¨å‘é€è¯·æ±‚å¤´
æµè§ˆå™¨å‘é€å…¶è¯·æ±‚å‘½ä»¤ä¹‹åï¼Œè¿˜è¦ä»¥å¤´ä¿¡æ¯çš„å½¢å¼å‘WebæœåŠ¡å™¨å‘é€ä¸€äº›åˆ«çš„ä¿¡æ¯ï¼Œä¹‹åæµè§ˆå™¨å‘é€äº†ä¸€ç©ºç™½è¡Œæ¥é€šçŸ¥æœåŠ¡å™¨ï¼Œå®ƒå·²ç»ç»“æŸäº†è¯¥å¤´ä¿¡æ¯çš„å‘é€ã€‚

WebæœåŠ¡å™¨åº”ç­”
å®¢æˆ·æœºå‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚åï¼ŒæœåŠ¡å™¨ä¼šå®¢æˆ·æœºå›é€åº”ç­”ï¼Œ HTTP/1.1 200 OK ï¼Œåº”ç­”çš„ç¬¬ä¸€éƒ¨åˆ†æ˜¯åè®®çš„ç‰ˆæœ¬å·å’Œåº”ç­”çŠ¶æ€ç ã€‚

WebæœåŠ¡å™¨å‘é€åº”ç­”å¤´
æ­£å¦‚å®¢æˆ·ç«¯ä¼šéšåŒè¯·æ±‚å‘é€å…³äºè‡ªèº«çš„ä¿¡æ¯ä¸€æ ·ï¼ŒæœåŠ¡å™¨ä¹Ÿä¼šéšåŒåº”ç­”å‘ç”¨æˆ·å‘é€å…³äºå®ƒè‡ªå·±çš„æ•°æ®åŠè¢«è¯·æ±‚çš„æ–‡æ¡£ã€‚

WebæœåŠ¡å™¨å‘æµè§ˆå™¨å‘é€æ•°æ®
WebæœåŠ¡å™¨å‘æµè§ˆå™¨å‘é€å¤´ä¿¡æ¯åï¼Œå®ƒä¼šå‘é€ä¸€ä¸ªç©ºç™½è¡Œæ¥è¡¨ç¤ºå¤´ä¿¡æ¯çš„å‘é€åˆ°æ­¤ä¸ºç»“æŸï¼Œæ¥ç€ï¼Œå®ƒå°±ä»¥Content-Typeåº”ç­”å¤´ä¿¡æ¯æ‰€æè¿°çš„æ ¼å¼å‘é€ç”¨æˆ·æ‰€è¯·æ±‚çš„å®é™…æ•°æ®ã€‚

WebæœåŠ¡å™¨å…³é—­TCPè¿æ¥
ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€æ—¦WebæœåŠ¡å™¨å‘æµè§ˆå™¨å‘é€äº†è¯·æ±‚æ•°æ®ï¼Œå®ƒå°±è¦å…³é—­TCPè¿æ¥ï¼Œç„¶åå¦‚æœæµè§ˆå™¨æˆ–è€…æœåŠ¡å™¨åœ¨å…¶å¤´ä¿¡æ¯åŠ å…¥äº†è¿™è¡Œä»£ç ï¼š

Connection:keep-alive
TCPè¿æ¥åœ¨å‘é€åå°†ä»ç„¶ä¿æŒæ‰“å¼€çŠ¶æ€ï¼Œäºæ˜¯ï¼Œæµè§ˆå™¨å¯ä»¥ç»§ç»­é€šè¿‡ç›¸åŒçš„è¿æ¥å‘é€è¯·æ±‚ã€‚ä¿æŒè¿æ¥èŠ‚çœäº†ä¸ºæ¯ä¸ªè¯·æ±‚å»ºç«‹æ–°è¿æ¥æ‰€éœ€çš„æ—¶é—´ï¼Œè¿˜èŠ‚çº¦äº†ç½‘ç»œå¸¦å®½ã€‚

å»ºç«‹TCPè¿æ¥->å‘é€è¯·æ±‚è¡Œ->å‘é€è¯·æ±‚å¤´->ï¼ˆåˆ°è¾¾æœåŠ¡å™¨ï¼‰å‘é€çŠ¶æ€è¡Œ->å‘é€å“åº”å¤´->å‘é€å“åº”æ•°æ®->æ–­TCPè¿æ¥
```

## Webå®‰å…¨(åŠ ä¸ŠåŸç†)

ä½ æ‰€äº†è§£åˆ°çš„Webæ”»å‡»æŠ€æœ¯
ï¼ˆ1ï¼‰XSSï¼ˆCross-Site Scriptingï¼Œè·¨ç«™è„šæœ¬æ”»å‡»ï¼‰ï¼šæŒ‡é€šè¿‡å­˜åœ¨å®‰å…¨æ¼æ´çš„Webç½‘ç«™æ³¨å†Œç”¨æˆ·çš„æµè§ˆå™¨å†…è¿è¡Œéæ³•çš„HTMLæ ‡ç­¾æˆ–è€…JavaScriptè¿›è¡Œçš„ä¸€ç§æ”»å‡»ã€‚
ï¼ˆ2ï¼‰SQLæ³¨å…¥æ”»å‡»
ï¼ˆ3ï¼‰CSRFï¼ˆCross-Site Request Forgeriesï¼Œè·¨ç«™ç‚¹è¯·æ±‚ä¼ªé€ ï¼‰ï¼šæŒ‡æ”»å‡»è€…é€šè¿‡è®¾ç½®å¥½çš„é™·é˜±ï¼Œå¼ºåˆ¶å¯¹å·²å®Œæˆçš„è®¤è¯ç”¨æˆ·è¿›è¡Œéé¢„æœŸçš„ä¸ªäººä¿¡æ¯æˆ–è®¾å®šä¿¡æ¯ç­‰æŸäº›çŠ¶æ€æ›´æ–°ã€‚

## è·¨åŸŸ

* åŸå› 
  æµè§ˆå™¨çš„åŒæºç­–ç•¥å¯¼è‡´äº†è·¨åŸŸ
* ä½œç”¨
  ç”¨äºéš”ç¦»æ½œåœ¨æ¶æ„æ–‡ä»¶çš„é‡è¦å®‰å…¨æœºåˆ¶
* è§£å†³
  ::: tip è§£å†³æ–¹æ¡ˆ
  jsonp ï¼Œå…è®¸ script åŠ è½½ç¬¬ä¸‰æ–¹èµ„æº

åå‘ä»£ç†ï¼ˆnginx æœåŠ¡å†…éƒ¨é…ç½® Access-Control-Allow-Origin *ï¼‰

cors å‰åç«¯åä½œè®¾ç½®è¯·æ±‚å¤´éƒ¨ï¼ŒAccess-Control-Allow-Origin ç­‰å¤´éƒ¨ä¿¡æ¯

iframe åµŒå¥—é€šè®¯ï¼Œpostmessage
:::

## DNSè§£æè¿‡ç¨‹

[DNSè§£æè¿‡ç¨‹](https://cloud.tencent.com/developer/news/324975)

## å†…å­˜æ³„æ¼

[å†…å­˜æ³„æ¼](http://www.ruanyifeng.com/blog/2017/04/memory-leak.html)

### Axiosä¸‹è½½æ–‡ä»¶æµå¤„ç†

```
axios({
  url: ``,
  method: "post",
  responseType: 'blob',
  data
}).then(res => {
  if(res.status !== 200) {
    return this.$message.error(res.statusText)
  } else {
    const elink = document.createElement('a'); // åˆ›å»ºä¸€ä¸ªaæ ‡ç­¾ç”¨äºä¸‹è½½
    elink.download = name; // è§„å®šè¢«ä¸‹è½½çš„è¶…é“¾æ¥ç›®æ ‡åï¼ˆæ–‡ä»¶åï¼‰
    elink.style.display = 'none';
    document.body.appendChild(elink);
    elink.click();
    document.body.removeChild(elink);
  }
}).catch(err => {
  console.log(err)
})
```

### ç»Ÿè®¡pv uv

[navigator.sendBacon](https://developer.mozilla.org/en-US/docs/Web/API/Navigator/sendBeacon) ä¸ŠæŠ¥åŸ‹ç‚¹æ•°æ®

```ts
 // Navigator.sendBeacon(url, blob) 
 // æµè§ˆå™¨tabåˆ‡æ¢ å’Œ æœ€å°åŒ–æµè§ˆå™¨ æˆ– å…³é—­çª—å£éƒ½æ˜¯æ‰§è¡Œä¸‹é¢æ–¹æ³•å¹¶ä¸ŠæŠ¥æ•°æ®
document.addEventListener('visibilitychange', function () {
    if (document.visibilityState === 'hidden') {
        const header = {
            type: 'application/x-www-form-urlencoded'
        }
        const blob = new Blob([JSON.stringify({name: 'Dendi', age: 88})], header)
        navigator.sendBeacon('http://localhost:5200/tracker', blob);
    }
})
```

### é‡å†™æµè§ˆå™¨çš„æ–¹æ³• pushState å’Œ replaceState

```ts
export const createHistoryEvent = <T extends keyof History>(type: T) => {
    const historyEvent = history[type]
    return function () {
        // è°ƒç”¨åŸç”Ÿäº‹ä»¶
        historyEvent.apply(this, arguments)
        // åˆ›å»ºæ–°äº‹ä»¶ dispatchäº‹ä»¶
        const e = new Event(type)
        window.dispatchEvent(e)
    }
}

window.history['pushState'] = createHistoryEvent('pushState')
window.history['replaceState'] = createHistoryEvent('replaceState')


// è·³è½¬è‡ªåŠ¨ä¸ŠæŠ¥
captureEvents(mouseEventList
:
string[]
)
{
    mouseEventList.forEach(event => window.addEventListener(event, () => {
        console.log('è·¯ç”±è·³è½¬ä¸ŠæŠ¥')
    }))
}

function installTracker() {
    if (this.data.historyTracker) {
        this.captureEvents(['pushState', 'replaceState', 'popstate'],)
    }
    if (this.data.hashTracker) {
        this.captureEvents(['hashchange'], 'hash-pv')
    }
}
```

### ç›‘å¬å…ƒç´ æ˜¯å¦åœ¨é¡µé¢ä¸­

[intersection Observer]('https://developer.mozilla.org/zh-CN/docs/Web/API/Intersection_Observer_API')

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        html,
        body {
            margin: 0
        }

        ul.main {
            list-style: none;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow-y: scroll;

            .list-item {
                margin: 20px 0;
                height: 80px;
                display: flex;
                justify-content: center;
                align-items: center;
                background-color: antiquewhite;

                .img {
                    margin-right: 80px;
                }

            }
        }
    </style>
</head>

<body>
<ul class="main">

</ul>
<script lang='ts'>
    window.onload = () => {
        const mainEl = document.querySelector('.main')
        const list = new Array(50).fill(' ')
        const fragment = document.createDocumentFragment()
        const getLiEl = (_, index) => {
            const liEl = document.createElement('li')
            liEl.innerHTML = `<img class="img" style="height: 80px"></img><span>${index + 1}</span>`
            liEl.style.cssText = `color: red; font-weight: bold; font-size: 24px`
            liEl.className = 'list-item'
            liEl.setAttribute('src', 'https://p2.img.cctvpic.com/photoAlbum/page/performance/img/2022/4/1/1648804913581_50.jpg')
            liEl.setAttribute('index', index + 1)
            return fragment.appendChild(liEl)
        }
        list.forEach(getLiEl)
        mainEl.append(fragment)

        let options = {
            root: document.querySelector('.main'),
            // é¢„å…ˆåŠ è½½ list-item: ä¸Šä¸‹margin 20, æœ¬èº«é«˜åº¦80 = 120px é¢„å…ˆåŠ è½½5 600px = 120px * 5
            rootMargin: '0px 0px 600px 0px',
            threshold: 0.5
        }

        const callback = (entries, io) => {
            entries.forEach(({target, isIntersecting}) => {
                if (isIntersecting) {
                    const index = target.getAttribute('index') * 1
                    const imgUri = target.getAttribute('src')
                    const img = target.querySelector('.img')
                    img.setAttribute('src', imgUri)
                    target.removeAttribute('src')
                    target.removeAttribute('index')
                    console.log(index)
                    // åœæ­¢è§‚å¯Ÿ
                    io.unobserve(target)

                    // å…³é—­è§‚å¯Ÿå™¨
                    // io.disconnect()
                }
            })
        }

        let observer = new IntersectionObserver(callback, options)
        const liEls = document.querySelectorAll('.list-item')
        // å¼€å§‹ç›‘å¬
        liEls.forEach(li => {
            observer.observe(li)
        })
    }
</script>
</body>

</html>
```

## getå’Œpostæœ‰ä»€ä¹ˆåŒºåˆ«

* 1.getä¸€èˆ¬æ˜¯è·å–æ•°æ®ï¼Œpostä¸€èˆ¬æ˜¯æäº¤æ•°æ®
* 2.getå‚æ•°ä¼šæ”¾åœ¨urlä¸Šï¼Œæ‰€ä»¥å®‰å…¨æ€§æ¯”è¾ƒå·®ï¼Œpostæ˜¯æ”¾åœ¨bodyä¸­
* 3.getè¯·æ±‚åˆ·æ–°æœåŠ¡å™¨æˆ–é€€å›æ˜¯æ²¡æœ‰å½±å“çš„ï¼Œpostè¯·æ±‚é€€å›æ—¶ä¼šé‡æ–°æäº¤æ•°æ®
* 4.getè¯·æ±‚æ—¶ä¼šè¢«ç¼“å­˜,postè¯·æ±‚ä¸ä¼šè¢«ç¼“å­˜
* 5.getè¯·æ±‚ä¼šè¢«ä¿å­˜åœ¨æµè§ˆå™¨å†å²è®°å½•ä¸­,postä¸ä¼š
* 6.getè¯·æ±‚åªèƒ½è¿›è¡Œurlç¼–ç ï¼Œpostè¯·æ±‚æ”¯æŒå¾ˆå¤šç§

## è§£é‡Šä¸€ä¸‹ä»€ä¹ˆæ˜¯json

* JSONæ˜¯ä¸€ç§çº¯å­—ç¬¦ä¸²å½¢å¼çš„æ•°æ®ï¼Œå®ƒæœ¬èº«ä¸æä¾›ä»»ä½•æ–¹æ³•ï¼Œé€‚åˆåœ¨ç½‘ç»œä¸­è¿›è¡Œä¼ è¾“
* JSONæ•°æ®å­˜å‚¨åœ¨.jsonæ–‡ä»¶ä¸­ï¼Œä¹Ÿå¯ä»¥æŠŠJSONæ•°æ®ä»¥å­—ç¬¦ä¸²çš„å½¢å¼ä¿å­˜åœ¨æ•°æ®åº“ã€Cookiseä¸­
* JSæä¾›äº†JSON.parse() JSON.stringify()
* ä»€ä¹ˆæ—¶å€™ä½¿ç”¨jsonï¼šå®šä¹‰æ¥å£ï¼›åºåˆ—åŒ–ï¼›ç”Ÿæˆtokenï¼›é…ç½®æ–‡ä»¶package.json

## HTTPåè®®è§„å®šçš„åè®®å¤´å’Œè¯·æ±‚å¤´æœ‰ä»€ä¹ˆ

* 1.è¯·æ±‚å¤´ä¿¡æ¯ï¼š

- Accept:æµè§ˆå™¨å‘Šè¯‰æœåŠ¡å™¨æ‰€æ”¯æŒçš„æ•°æ®ç±»å‹
- Host:æµè§ˆå™¨å‘Šè¯‰æœåŠ¡å™¨æˆ‘æƒ³è®¿é—®æœåŠ¡å™¨çš„å“ªå°ä¸»æœº
- Referer:æµè§ˆå™¨å‘Šè¯‰æœåŠ¡å™¨æˆ‘æ˜¯ä»å“ªé‡Œæ¥çš„ï¼ˆé˜²ç›—é“¾ï¼‰
- User-Agent:æµè§ˆå™¨ç±»å‹ã€ç‰ˆæœ¬ä¿¡æ¯
- Date:æµè§ˆå™¨å‘Šè¯‰æœåŠ¡å™¨æˆ‘æ˜¯ä»€ä¹ˆæ—¶å€™è®¿é—®çš„
- Connection:è¿æ¥æ–¹å¼
- Cookie
- X-Request-With:è¯·æ±‚æ–¹å¼

* 2.å“åº”å¤´ä¿¡æ¯ï¼š

- Location:è¿™ä¸ªå°±æ˜¯å‘Šè¯‰æµè§ˆå™¨ä½ è¦å»æ‰¾è°
- Server:å‘Šè¯‰æµè§ˆå™¨æœåŠ¡å™¨çš„ç±»å‹
- Content-Type:å‘Šè¯‰æµè§ˆå™¨è¿”å›çš„æ•°æ®ç±»å‹
- Refresh:æ§åˆ¶äº†çš„å®šæ—¶åˆ·æ–°


# WebSocket å¿ƒè·³æ£€æµ‹ - é¢è¯•æ ‡å‡†ç­”æ¡ˆ

## ğŸ“‹ ç›®å½•
- [å¼€åœºç™½](#å¼€åœºç™½)
- [æ ¸å¿ƒå›ç­”](#æ ¸å¿ƒå›ç­”)
- [å®Œæ•´å›ç­”ç¤ºä¾‹](#å®Œæ•´å›ç­”ç¤ºä¾‹)
- [å¸¸è§è¿½é—®åŠå›ç­”](#å¸¸è§è¿½é—®åŠå›ç­”)
- [å›ç­”è¦ç‚¹æ€»ç»“](#å›ç­”è¦ç‚¹æ€»ç»“)

---

## ğŸ¯ å¼€åœºç™½ï¼ˆ30ç§’ï¼‰

> "å¿ƒè·³æ£€æµ‹æ˜¯ WebSocket è¿æ¥ä¿æ´»å’Œæ•…éšœæ£€æµ‹çš„æœºåˆ¶ã€‚æˆ‘åœ¨é¡¹ç›®ä¸­å®ç°è¿‡ä¸€å¥—å®Œæ•´çš„å¿ƒè·³æœºåˆ¶ï¼ŒåŒ…æ‹¬å®šæ—¶å‘é€ã€è¶…æ—¶æ£€æµ‹å’Œè‡ªåŠ¨é‡è¿ã€‚"

---

## ğŸ’¡ æ ¸å¿ƒå›ç­”ï¼ˆ2-3åˆ†é’Ÿï¼‰

### 1. ä¸ºä»€ä¹ˆéœ€è¦å¿ƒè·³æ£€æµ‹ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆï¼š**
"ä¸»è¦æœ‰ä¸‰ä¸ªåŸå› ï¼š

1. **æ£€æµ‹å‡è¿æ¥**ï¼šç½‘ç»œå±‚æ–­å¼€ä½†åº”ç”¨å±‚æœªæ„ŸçŸ¥ï¼Œ`readyState` ä»ä¸º `OPEN`ï¼Œéœ€è¦ä¸»åŠ¨æ¢æµ‹
2. **ä¿æŒè¿æ¥æ´»è·ƒ**ï¼šä¸­é—´è®¾å¤‡ï¼ˆè·¯ç”±å™¨ã€NATã€é˜²ç«å¢™ï¼‰å¯èƒ½å› ç©ºé—²è¶…æ—¶æ–­å¼€é•¿è¿æ¥
3. **åŠæ—¶å‘ç°æ•…éšœ**ï¼šå¿«é€Ÿå‘ç°é—®é¢˜å¹¶è§¦å‘é‡è¿ï¼Œæå‡ç”¨æˆ·ä½“éªŒ"

### 2. å®ç°æ–¹æ¡ˆ

**æ ‡å‡†ç­”æ¡ˆï¼š**
"æˆ‘é‡‡ç”¨ **Ping-Pong æœºåˆ¶**ï¼š

- å®¢æˆ·ç«¯æ¯ **10 ç§’**å‘é€ `'ping'` å­—ç¬¦ä¸²
- æœåŠ¡å™¨æ”¶åˆ°åå“åº” `'pong'` å­—ç¬¦ä¸²
- å¦‚æœ **30 ç§’**å†…æ²¡æ”¶åˆ° `'pong'`ï¼Œåˆ¤å®šè¿æ¥å¼‚å¸¸å¹¶å…³é—­ï¼Œè§¦å‘è‡ªåŠ¨é‡è¿"

### 3. æŠ€æœ¯ç»†èŠ‚

**æ ‡å‡†ç­”æ¡ˆï¼š**
"å®ç°ä¸Šç”¨äº†**ä¸¤ä¸ªå®šæ—¶å™¨**ï¼š

- `setInterval`ï¼šå®šæ—¶å‘é€ `ping`ï¼ˆ10 ç§’é—´éš”ï¼‰
- `setTimeout`ï¼šæ£€æµ‹è¶…æ—¶ï¼ˆ30 ç§’è¶…æ—¶ï¼‰

**å…³é”®ç‚¹ï¼š**
- æ¯æ¬¡å‘é€ `ping` åé‡ç½®è¶…æ—¶å®šæ—¶å™¨
- æ”¶åˆ° `pong` åä¹Ÿé‡ç½®è¶…æ—¶å®šæ—¶å™¨
- è¿æ¥å…³é—­æ—¶æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨ï¼Œé¿å…å†…å­˜æ³„æ¼
- è¶…æ—¶æ—¶é—´è®¾ç½®ä¸ºå‘é€é—´éš”çš„ 3 å€ï¼Œé¿å…ç½‘ç»œæŠ–åŠ¨è¯¯åˆ¤"

### 4. å·¥ç¨‹å®è·µ

**æ ‡å‡†ç­”æ¡ˆï¼š**
"åœ¨ `onopen` æ—¶å¯åŠ¨å¿ƒè·³ï¼Œåœ¨ `onclose` æ—¶åœæ­¢ã€‚è¶…æ—¶åå…³é—­è¿æ¥ï¼Œè§¦å‘ `onclose`ï¼Œè¿›è€Œè§¦å‘è‡ªåŠ¨é‡è¿ã€‚è¿™æ ·å½¢æˆé—­ç¯ï¼Œç¡®ä¿è¿æ¥å¯ç”¨æ€§ã€‚"

---

## ğŸ¤ å®Œæ•´å›ç­”ç¤ºä¾‹ï¼ˆ3-5åˆ†é’Ÿï¼‰

**é¢è¯•å®˜ï¼š** è¯·ä»‹ç»ä¸€ä¸‹ WebSocket çš„å¿ƒè·³æ£€æµ‹æœºåˆ¶ã€‚

**ä½ ï¼š**
> "å¥½çš„ï¼Œæˆ‘æ¥è¯´ä¸€ä¸‹æˆ‘åœ¨é¡¹ç›®ä¸­å®ç°çš„å¿ƒè·³æ£€æµ‹æœºåˆ¶ã€‚
>
> **é¦–å…ˆï¼Œä¸ºä»€ä¹ˆéœ€è¦å¿ƒè·³æ£€æµ‹ï¼Ÿ** ä¸»è¦æœ‰ä¸‰ä¸ªåŸå› ï¼š
> 1. **æ£€æµ‹å‡è¿æ¥**ï¼šç½‘ç»œå±‚æ–­å¼€ä½†åº”ç”¨å±‚æœªæ„ŸçŸ¥
> 2. **ä¿æŒè¿æ¥æ´»è·ƒ**ï¼šé˜²æ­¢ä¸­é—´è®¾å¤‡å› ç©ºé—²æ–­å¼€
> 3. **åŠæ—¶å‘ç°æ•…éšœ**ï¼šå¿«é€Ÿè§¦å‘é‡è¿
>
> **æˆ‘çš„å®ç°æ–¹æ¡ˆæ˜¯ Ping-Pong æœºåˆ¶ï¼š**
> - å®¢æˆ·ç«¯æ¯ 10 ç§’å‘é€ `'ping'` å­—ç¬¦ä¸²
> - æœåŠ¡å™¨æ”¶åˆ°åå“åº” `'pong'`
> - å¦‚æœ 30 ç§’å†…æ²¡æ”¶åˆ° `'pong'`ï¼Œåˆ¤å®šè¿æ¥å¼‚å¸¸
>
> **æŠ€æœ¯å®ç°ä¸Šï¼Œæˆ‘ç”¨äº†ä¸¤ä¸ªå®šæ—¶å™¨ï¼š**
> - `setInterval`ï¼šå®šæ—¶å‘é€ `ping`ï¼ˆ10 ç§’é—´éš”ï¼‰
> - `setTimeout`ï¼šæ£€æµ‹è¶…æ—¶ï¼ˆ30 ç§’è¶…æ—¶ï¼‰
>
> **å…³é”®é€»è¾‘æ˜¯ï¼š**
> - æ¯æ¬¡å‘é€ `ping` åé‡ç½®è¶…æ—¶å®šæ—¶å™¨
> - æ”¶åˆ° `pong` åä¹Ÿé‡ç½®è¶…æ—¶å®šæ—¶å™¨
> - è¿™æ ·åªè¦è¿æ¥æ­£å¸¸ï¼Œè¶…æ—¶å®šæ—¶å™¨ä¼šä¸æ–­è¢«é‡ç½®
> - å¦‚æœè¿æ¥æ–­å¼€ï¼Œ30 ç§’åè§¦å‘è¶…æ—¶ï¼Œå…³é—­è¿æ¥å¹¶è§¦å‘é‡è¿
>
> **åœ¨å·¥ç¨‹å®è·µä¸Šï¼š**
> - è¿æ¥å»ºç«‹æ—¶ï¼ˆ`onopen`ï¼‰å¯åŠ¨å¿ƒè·³
> - è¿æ¥å…³é—­æ—¶ï¼ˆ`onclose`ï¼‰åœæ­¢å¿ƒè·³å¹¶æ¸…ç†å®šæ—¶å™¨
> - è¶…æ—¶åå…³é—­è¿æ¥ï¼Œè§¦å‘è‡ªåŠ¨é‡è¿æœºåˆ¶
>
> **è¿™ä¸ªæ–¹æ¡ˆçš„ä¼˜åŠ¿æ˜¯ï¼š**
> 1. è‡ªåŠ¨æ£€æµ‹ï¼Œæ— éœ€äººå·¥å¹²é¢„
> 2. åŠæ—¶å“åº”ï¼Œ30 ç§’å†…å‘ç°é—®é¢˜
> 3. èµ„æºå®‰å…¨ï¼Œæ­£ç¡®æ¸…ç†å®šæ—¶å™¨
> 4. ä¸é‡è¿æœºåˆ¶è”åŠ¨ï¼Œå½¢æˆå®Œæ•´çš„å®¹é”™ä½“ç³»
>
> **æˆ‘åœ¨å®é™…é¡¹ç›®ä¸­è¿˜é‡åˆ°è¿‡ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚ï¼š**
> - **å†…å­˜æ³„æ¼**ï¼šå¿˜è®°æ¸…ç†å®šæ—¶å™¨ï¼Œåæ¥åœ¨ `onclose` ä¸­ç»Ÿä¸€æ¸…ç†
> - **è¯¯åˆ¤**ï¼šè¶…æ—¶æ—¶é—´è®¾ç½®ä¸åˆç†ï¼Œåæ¥è°ƒæ•´ä¸ºå‘é€é—´éš”çš„ 3 å€
> - **é‡è¿é£æš´**ï¼šç½‘ç»œä¸ç¨³å®šæ—¶é¢‘ç¹é‡è¿ï¼Œåæ¥åŠ å…¥äº†æŒ‡æ•°é€€é¿å’Œæœ€å¤§é‡è¿æ¬¡æ•°é™åˆ¶
>
> è¿™å°±æ˜¯æˆ‘å®ç°çš„å¿ƒè·³æ£€æµ‹æœºåˆ¶ã€‚"

---

## ğŸ” å¸¸è§è¿½é—®åŠå›ç­”

### Q1: å¿ƒè·³é¢‘ç‡å¦‚ä½•é€‰æ‹©ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆï¼š**
> "éœ€è¦å¹³è¡¡å®æ—¶æ€§å’Œèµ„æºæ¶ˆè€—ï¼š
> - **å®æ—¶æ€§è¦æ±‚é«˜**ï¼šå¯ä»¥ 5 ç§’ï¼ˆå¦‚è‚¡ç¥¨è¡Œæƒ…ï¼‰
> - **ä¸€èˆ¬åœºæ™¯**ï¼š10-30 ç§’ï¼ˆå¦‚èŠå¤©ã€é€šçŸ¥ï¼‰
> - **ä½é¢‘åœºæ™¯**ï¼šå¯ä»¥æ›´é•¿ï¼ˆå¦‚çŠ¶æ€åŒæ­¥ï¼‰
>
> æˆ‘ä»¬é€‰æ‹© 10 ç§’æ˜¯ç»¼åˆè€ƒè™‘äº†å®æ—¶æ€§å’ŒæœåŠ¡å™¨å‹åŠ›ã€‚"

### Q2: æœåŠ¡å™¨ç«¯å¦‚ä½•å®ç°ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆï¼š**
> "æœåŠ¡å™¨ç«¯æ”¶åˆ° `ping` åç«‹å³è¿”å› `pong`ã€‚å¯ä»¥ç”¨å®šæ—¶å™¨å®šæœŸæ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦è¶…æ—¶ï¼Œä¹Ÿå¯ä»¥åŸºäºå¿ƒè·³æ—¶é—´æˆ³åˆ¤æ–­ã€‚æˆ‘ä»¬ç”¨çš„æ˜¯æ—¶é—´æˆ³æ–¹å¼ï¼Œè®°å½•æ¯ä¸ªè¿æ¥çš„æœ€åå¿ƒè·³æ—¶é—´ï¼Œå®šæœŸæ‰«æè¶…æ—¶çš„è¿æ¥å¹¶å…³é—­ã€‚"

### Q3: å¿ƒè·³ä¼šå½±å“æ€§èƒ½å—ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆï¼š**
> "å½±å“å¾ˆå°ï¼š
> - `ping`/`pong` æ˜¯çŸ­å­—ç¬¦ä¸²ï¼Œä¼ è¾“é‡å°ï¼ˆå‡ ä¸ªå­—èŠ‚ï¼‰
> - å®šæ—¶å™¨å¼€é”€ä¹Ÿå¾ˆä½
> - ç›¸æ¯”è¿æ¥æ–­å¼€çš„ä»£ä»·ï¼Œå¿ƒè·³æˆæœ¬å¯å¿½ç•¥
>
> å®é™…æµ‹è¯•ä¸­ï¼Œ1000 ä¸ªè¿æ¥çš„å¿ƒè·³å¼€é”€ä¸åˆ° 1% CPUã€‚"

### Q4: ä¸ºä»€ä¹ˆæ˜¯ 10 ç§’å’Œ 30 ç§’ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆï¼š**
> "è¿™æ˜¯å¹³è¡¡çš„ç»“æœï¼š
> - **10 ç§’å‘é€é—´éš”**ï¼šä¸ä¼šè¿‡äºé¢‘ç¹ï¼Œä¹Ÿä¸ä¼šé—´éš”å¤ªé•¿
> - **30 ç§’è¶…æ—¶**ï¼šç»™ç½‘ç»œå»¶è¿Ÿå’ŒæœåŠ¡å™¨å¤„ç†ç•™å‡ºç¼“å†²
> - **è¶…æ—¶æ—¶é—´ = å‘é€é—´éš” Ã— 3**ï¼Œé¿å…è¯¯åˆ¤
>
> å®é™…é¡¹ç›®ä¸­å¯ä»¥æ ¹æ®ä¸šåŠ¡è°ƒæ•´ï¼Œæ¯”å¦‚å®æ—¶æ€§è¦æ±‚é«˜çš„å¯ä»¥ç¼©çŸ­åˆ° 5 ç§’ã€‚"

### Q5: æœ‰æ²¡æœ‰å…¶ä»–æ–¹æ¡ˆï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆï¼š**
> "è¿˜æœ‰å‡ ç§æ–¹æ¡ˆï¼š
> 1. **TCP Keep-Alive**ï¼šç³»ç»Ÿå±‚ï¼Œä½†ä¸å¤Ÿçµæ´»
> 2. **åº”ç”¨å±‚å¿ƒè·³**ï¼šæ›´å¯æ§ï¼Œæˆ‘ä»¬ç”¨çš„å°±æ˜¯è¿™ç§
> 3. **WebSocket Ping/Pong å¸§**ï¼šåè®®å±‚ï¼Œä½†æµè§ˆå™¨ API ä¸æ”¯æŒå‘é€ Ping å¸§
>
> æˆ‘ä»¬é€‰æ‹©åº”ç”¨å±‚å¿ƒè·³ï¼Œå› ä¸ºå…¼å®¹æ€§å¥½ã€å¯æ§æ€§å¼ºã€‚"

### Q6: é‡åˆ°è¿‡ä»€ä¹ˆé—®é¢˜ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆï¼š**
> "é‡åˆ°è¿‡å‡ ä¸ªé—®é¢˜ï¼š
> 1. **å†…å­˜æ³„æ¼**ï¼šå¿˜è®°æ¸…ç†å®šæ—¶å™¨ï¼Œå·²ä¿®å¤
> 2. **è¯¯åˆ¤**ï¼šè¶…æ—¶æ—¶é—´è®¾ç½®ä¸åˆç†ï¼Œå·²è°ƒæ•´ä¸ºå‘é€é—´éš”çš„ 3 å€
> 3. **é‡è¿é£æš´**ï¼šç½‘ç»œä¸ç¨³å®šæ—¶é¢‘ç¹é‡è¿ï¼Œå·²åŠ å…¥æŒ‡æ•°é€€é¿å’Œæœ€å¤§é‡è¿æ¬¡æ•°é™åˆ¶
> 4. **æ—¶åŒºé—®é¢˜**ï¼šæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯æ—¶åŒºä¸ä¸€è‡´å¯¼è‡´æ—¶é—´æˆ³åˆ¤æ–­é”™è¯¯ï¼Œåæ¥ç»Ÿä¸€ä½¿ç”¨ UTC æ—¶é—´"

---

## âœ… å›ç­”è¦ç‚¹æ€»ç»“

### å›ç­”ç»“æ„
1. âœ… **ç»“æ„æ¸…æ™°**ï¼šé—®é¢˜ â†’ æ–¹æ¡ˆ â†’ å®ç° â†’ å®è·µ
2. âœ… **æœ‰æ•°æ®**ï¼š10 ç§’ã€30 ç§’ç­‰å…·ä½“å‚æ•°
3. âœ… **æœ‰æ€è€ƒ**ï¼šä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡
4. âœ… **æœ‰ç»éªŒ**ï¼šé‡åˆ°è¿‡çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
5. âœ… **æœ‰æ·±åº¦**ï¼šæŠ€æœ¯ç»†èŠ‚å’Œå·¥ç¨‹å®è·µ

### å›ç­”æŠ€å·§
- ğŸ¯ **å…ˆè¯´ç»“è®º**ï¼šç›´æ¥è¯´æ˜æ˜¯ä»€ä¹ˆ
- ğŸ“Š **å†è¯´åŸç†**ï¼šè§£é‡Šä¸ºä»€ä¹ˆ
- ğŸ”§ **æœ€åè¯´å®ç°**ï¼šå±•ç¤ºæ€ä¹ˆåš
- ğŸ’¡ **è¡¥å……ç»éªŒ**ï¼šåˆ†äº«è¸©è¿‡çš„å‘

### å…³é”®æ•°æ®
- **å‘é€é—´éš”**ï¼š10 ç§’
- **è¶…æ—¶æ—¶é—´**ï¼š30 ç§’
- **è¶…æ—¶å€æ•°**ï¼šå‘é€é—´éš” Ã— 3
- **æœ€å¤§é‡è¿æ¬¡æ•°**ï¼š5 æ¬¡
- **é‡è¿é—´éš”**ï¼š3 ç§’

---

## ğŸ“ ä»£ç ç¤ºä¾‹ï¼ˆå¯é€‰å±•ç¤ºï¼‰

å¦‚æœé¢è¯•å®˜è¦æ±‚çœ‹ä»£ç ï¼Œå¯ä»¥å±•ç¤ºæ ¸å¿ƒéƒ¨åˆ†ï¼š

```javascript
// å¯åŠ¨å¿ƒè·³
startHeartbeat() {
  if (this.heartbeatTimer) return

  // æ¯ 10 ç§’å‘é€ä¸€æ¬¡ ping
  this.heartbeatTimer = setInterval(() => {
    if (this.socket && this.socket.readyState === WebSocket.OPEN) {
      this.socket.send('ping')
      this.resetHeartbeatTimeout() // é‡ç½®è¶…æ—¶å®šæ—¶å™¨
    }
  }, 10000)
  
  this.resetHeartbeatTimeout()
}

// é‡ç½®è¶…æ—¶å®šæ—¶å™¨
resetHeartbeatTimeout() {
  if (this.heartbeatTimeoutTimer) {
    clearTimeout(this.heartbeatTimeoutTimer)
  }
  
  // 30 ç§’å†…æ²¡æ”¶åˆ° pong å°±è¶…æ—¶
  this.heartbeatTimeoutTimer = setTimeout(() => {
    console.warn('Heartbeat timeout, closing connection')
    if (this.socket) {
      this.socket.close() // å…³é—­è¿æ¥ï¼Œè§¦å‘é‡è¿
    }
  }, 30000)
}

// æ¥æ”¶æ¶ˆæ¯æ—¶å¤„ç† pong
onmessage = (event) => {
  if (event.data === 'pong') {
    this.resetHeartbeatTimeout() // æ”¶åˆ° pongï¼Œé‡ç½®è¶…æ—¶
    return
  }
  // ... å¤„ç†å…¶ä»–æ¶ˆæ¯
}
```

---

## ğŸ“ è¿›é˜¶çŸ¥è¯†ç‚¹ï¼ˆåŠ åˆ†é¡¹ï¼‰

### 1. å¿ƒè·³åè®®è®¾è®¡
- ä½¿ç”¨ç®€å•çš„å­—ç¬¦ä¸² `'ping'`/`'pong'`ï¼Œé¿å… JSON è§£æå¼€é”€
- ä¹Ÿå¯ä»¥ä½¿ç”¨ JSON æ ¼å¼ï¼Œä¾¿äºæ‰©å±•ï¼ˆå¦‚æºå¸¦æ—¶é—´æˆ³ï¼‰

### 2. è¶…æ—¶æ—¶é—´è®¡ç®—
- è¶…æ—¶æ—¶é—´ = å‘é€é—´éš” Ã— 2-3 å€
- è€ƒè™‘ç½‘ç»œå»¶è¿Ÿã€æœåŠ¡å™¨å¤„ç†æ—¶é—´ã€æ—¶é’Ÿåå·®

### 3. å¿ƒè·³ä¸é‡è¿çš„è”åŠ¨
- å¿ƒè·³è¶…æ—¶ â†’ å…³é—­è¿æ¥ â†’ è§¦å‘ `onclose` â†’ è‡ªåŠ¨é‡è¿
- å½¢æˆå®Œæ•´çš„å®¹é”™é—­ç¯

### 4. èµ„æºç®¡ç†
- è¿æ¥å…³é—­æ—¶æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
- é¿å…å†…å­˜æ³„æ¼å’Œæ— æ•ˆçš„å®šæ—¶å™¨æ‰§è¡Œ

### 5. æ€§èƒ½ä¼˜åŒ–
- å¿ƒè·³æ¶ˆæ¯å°½é‡å°ï¼ˆå­—ç¬¦ä¸²ä¼˜äº JSONï¼‰
- æ‰¹é‡å¤„ç†å¤šä¸ªè¿æ¥çš„å¿ƒè·³
- ä½¿ç”¨ Web Worker å¤„ç†å¿ƒè·³ï¼ˆå¯é€‰ï¼‰

---

## ğŸ“š ç›¸å…³çŸ¥è¯†ç‚¹

### WebSocket çŠ¶æ€
- `WebSocket.CONNECTING` (0) - è¿æ¥ä¸­
- `WebSocket.OPEN` (1) - å·²è¿æ¥
- `WebSocket.CLOSING` (2) - å…³é—­ä¸­
- `WebSocket.CLOSED` (3) - å·²å…³é—­

### å¿ƒè·³æ£€æµ‹æ—¶æœº
- âœ… è¿æ¥å»ºç«‹æ—¶å¯åŠ¨
- âœ… è¿æ¥å…³é—­æ—¶åœæ­¢
- âœ… è¶…æ—¶æ—¶å…³é—­è¿æ¥

### æœ€ä½³å®è·µ
1. âœ… è¶…æ—¶æ—¶é—´ > å‘é€é—´éš” Ã— 2
2. âœ… åŠæ—¶æ¸…ç†å®šæ—¶å™¨
3. âœ… ä¸é‡è¿æœºåˆ¶è”åŠ¨
4. âœ… è®°å½•å¿ƒè·³æ—¥å¿—ï¼ˆä¾¿äºæ’æŸ¥é—®é¢˜ï¼‰

---

**æœ€åæ›´æ–°ï¼š** 2024å¹´

**é€‚ç”¨åœºæ™¯ï¼š** WebSocket ç›¸å…³é¢è¯•ã€æŠ€æœ¯åˆ†äº«ã€ä»£ç å®¡æŸ¥


## è¯´è¯´TCPä¸ºä»€ä¹ˆéœ€è¦ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹

https://vue3js.cn/interview/http/handshakes_waves.html#%E4%B8%80%E3%80%81%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B